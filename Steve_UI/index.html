<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTR æ™ºèƒ½è¨˜éŒ„å™¨ (GPS+CSV)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .btn-main { transition: all 0.3s ease; }
        .btn-main:active { transform: scale(0.95); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-6 px-4">

    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden relative">
        
        <div class="bg-blue-900 p-4 text-white text-center flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-satellite-dish mr-2"></i>MTR GPS</h1>
            <div class="text-xs bg-blue-800 px-2 py-1 rounded" id="gps-status">GPS å¾…æ©Ÿ</div>
        </div>

        <div class="p-6 flex flex-col items-center justify-center space-y-4">
            <div id="status-display" class="text-gray-500 font-medium mb-2">
                ç•¶å‰ç‹€æ…‹: <span class="text-red-500">æœªå…¥é–˜</span>
            </div>

            <button id="action-btn" onclick="openStationModal()" class="btn-main w-40 h-40 rounded-full bg-green-500 text-white text-2xl font-bold shadow-lg flex flex-col items-center justify-center border-4 border-green-200">
                <div><i class="fas fa-sign-in-alt mb-2 text-3xl"></i></div>
                <span>å…¥é–˜</span>
            </button>

            <div id="current-trip-info" class="hidden w-full bg-blue-50 p-3 rounded-lg text-sm text-blue-800 mt-4 border border-blue-100">
                <p>ğŸ“ å…¥ç«™: <span id="info-entry-station" class="font-bold">--</span></p>
                <p>ğŸ•’ æ™‚é–“: <span id="info-entry-time">--</span></p>
            </div>
        </div>

        <div class="bg-gray-50 p-4 border-t border-gray-200 h-80 flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700">æ­·å²ç´€éŒ„</h2>
                <div class="flex space-x-3">
                    <!-- æ–°å¢ CSV ä¸‹è¼‰æŒ‰éˆ• -->
                    <button onclick="downloadCSV()" class="text-xs text-green-600 hover:text-green-800 font-bold flex items-center">
                        <i class="fas fa-file-csv mr-1"></i>åŒ¯å‡º CSV
                    </button>
                    <button onclick="clearHistory()" class="text-xs text-red-500 hover:text-red-700 underline">æ¸…é™¤</button>
                </div>
            </div>
            
            <div class="overflow-y-auto flex-1 space-y-3 no-scrollbar" id="history-list">
                <p class="text-center text-gray-400 text-sm py-4">æš«ç„¡ç´€éŒ„</p>
            </div>
        </div>

        <!-- å½ˆå‡ºå¼é¸ç«™è¦–çª— -->
        <div id="station-modal" class="hidden absolute inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center transition-opacity duration-300">
            <div class="bg-white w-full sm:w-5/6 rounded-t-2xl sm:rounded-xl p-6 shadow-2xl transform transition-transform duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800" id="modal-title">è«‹é¸æ“‡è»Šç«™</h3>
                    <button onclick="detectLocation()" class="text-blue-600 text-sm flex items-center">
                        <i class="fas fa-location-arrow mr-1"></i> é‡æ–°å®šä½
                    </button>
                </div>

                <div id="location-msg" class="mb-2 text-xs text-gray-500 h-5 flex items-center"></div>
                
                <div class="relative mb-6">
                    <select id="station-select" class="block w-full p-3 bg-gray-50 border border-gray-300 text-gray-900 text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <!-- é¸é …ç”± JS ç”Ÿæˆ -->
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button onclick="closeModal()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300">å–æ¶ˆ</button>
                    <button onclick="confirmAction()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg">ç¢ºèª</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. è»Šç«™åº§æ¨™è³‡æ–™åº« ---
        const stationCoords = {
            "å …å°¼åœ°åŸ": [22.2811, 114.1264], "é¦™æ¸¯å¤§å­¸": [22.2842, 114.1362], "è¥¿ç‡Ÿç›¤": [22.2863, 114.1415],
            "ä¸Šç’°": [22.2874, 114.1517], "ä¸­ç’°": [22.2819, 114.1582], "é‡‘é˜": [22.2794, 114.1645],
            "ç£ä»”": [22.2782, 114.1736], "éŠ…é‘¼ç£": [22.2804, 114.1852], "å¤©å": [22.2825, 114.1914],
            "ç‚®å°å±±": [22.2878, 114.1936], "åŒ—è§’": [22.2913, 114.2005], "é°‚é­šæ¶Œ": [22.2882, 114.2124],
            "å¤ªå¤": [22.2846, 114.2166], "è¥¿ç£æ²³": [22.2822, 114.2223], "ç­²ç®•ç£": [22.2796, 114.2274],
            "æèŠ±é‚¨": [22.2754, 114.2405], "æŸ´ç£": [22.2646, 114.2366],
            "å°–æ²™å’€": [22.2976, 114.1722], "ä½æ•¦": [22.3049, 114.1717], "æ²¹éº»åœ°": [22.3130, 114.1706],
            "æ—ºè§’": [22.3193, 114.1694], "å¤ªå­": [22.3245, 114.1685], "æ·±æ°´åŸ—": [22.3307, 114.1616],
            "é•·æ²™ç£": [22.3355, 114.1566], "è”æè§’": [22.3371, 114.1484], "ç¾å­š": [22.3366, 114.1385],
            "è”æ™¯": [22.3496, 114.1264], "è‘µèŠ³": [22.3557, 114.1269], "è‘µèˆˆ": [22.3634, 114.1309],
            "å¤§çª©å£": [22.3708, 114.1232], "èƒç£": [22.3734, 114.1176],
            "ä¹é¾å¡˜": [22.3367, 114.1761], "æ¨‚å¯Œ": [22.3378, 114.1873], "é»ƒå¤§ä»™": [22.3420, 114.1932],
            "é‘½çŸ³å±±": [22.3400, 114.2016], "å½©è™¹": [22.3340, 114.2093], "ä¹é¾ç£": [22.3234, 114.2141],
            "ç‰›é ­è§’": [22.3153, 114.2191], "è§€å¡˜": [22.3120, 114.2255], "è—ç”°": [22.3073, 114.2319],
            "æ²¹å¡˜": [22.2974, 114.2422], "èª¿æ™¯å¶º": [22.3023, 114.2526], "å°‡è»æ¾³": [22.3074, 114.2600],
            "åº·åŸ": [22.2954, 114.2686], "å‘å£": [22.3155, 114.2647], "å¯¶ç³": [22.3228, 114.2580],
            "ç´…ç£¡": [22.3031, 114.1818], "å¤§åœ": [22.3725, 114.1783], "æ²™ç”°": [22.3831, 114.1876],
            "ç«ç‚­": [22.3962, 114.1963], "å¤§å­¸": [22.4131, 114.2097], "å¤§åŸ”å¢Ÿ": [22.4447, 114.1695],
            "å¤ªå’Œ": [22.4510, 114.1641], "ç²‰å¶º": [22.4918, 114.1388], "ä¸Šæ°´": [22.5013, 114.1278],
            "ç¾…æ¹–": [22.5279, 114.1132], "è½é¦¬æ´²": [22.5152, 114.0666],
            "æŸ¯å£«ç”¸": [22.3043, 114.1664], "å—æ˜Œ": [22.3265, 114.1536], "èƒç£è¥¿": [22.3683, 114.1105],
            "éŒ¦ä¸Šè·¯": [22.4361, 114.0656], "å…ƒæœ—": [22.4452, 114.0348], "æœ—å±": [22.4497, 114.0254],
            "å¤©æ°´åœ": [22.4495, 114.0040], "å…†åº·": [22.4116, 109.9806], "å±¯é–€": [22.3953, 109.9734],
            "é¦™æ¸¯": [22.2849, 114.1583], "ä¹é¾": [22.3045, 114.1614], "å¥§é‹": [22.3188, 114.1587],
            "é’è¡£": [22.3585, 114.1068], "æ±æ¶Œ": [22.2892, 113.9413], "æ¬£æ¾³": [22.3242, 114.0279]
        };

        const mtrLines = {
            "å¸¸ç”¨": ["æ—ºè§’", "ä¸­ç’°", "é‡‘é˜", "éŠ…é‘¼ç£", "å°–æ²™å’€", "ä¹é¾å¡˜"],
            "æ¸¯å³¶ç¶«": ["å …å°¼åœ°åŸ", "é¦™æ¸¯å¤§å­¸", "è¥¿ç‡Ÿç›¤", "ä¸Šç’°", "ä¸­ç’°", "é‡‘é˜", "ç£ä»”", "éŠ…é‘¼ç£", "å¤©å", "ç‚®å°å±±", "åŒ—è§’", "é°‚é­šæ¶Œ", "å¤ªå¤", "è¥¿ç£æ²³", "ç­²ç®•ç£", "æèŠ±é‚¨", "æŸ´ç£"],
            "èƒç£ç¶«": ["ä¸­ç’°", "é‡‘é˜", "å°–æ²™å’€", "ä½æ•¦", "æ²¹éº»åœ°", "æ—ºè§’", "å¤ªå­", "æ·±æ°´åŸ—", "é•·æ²™ç£", "è”æè§’", "ç¾å­š", "è”æ™¯", "è‘µèŠ³", "è‘µèˆˆ", "å¤§çª©å£", "èƒç£"],
            "è§€å¡˜ç¶«": ["é»ƒåŸ”", "ä½•æ–‡ç”°", "æ²¹éº»åœ°", "æ—ºè§’", "å¤ªå­", "çŸ³ç¡¤å°¾", "ä¹é¾å¡˜", "æ¨‚å¯Œ", "é»ƒå¤§ä»™", "é‘½çŸ³å±±", "å½©è™¹", "ä¹é¾ç£", "ç‰›é ­è§’", "è§€å¡˜", "è—ç”°", "æ²¹å¡˜", "èª¿æ™¯å¶º"],
            "æ±éµç¶«": ["é‡‘é˜", "æœƒå±•", "ç´…ç£¡", "æ—ºè§’æ±", "ä¹é¾å¡˜", "å¤§åœ", "æ²™ç”°", "ç«ç‚­", "é¦¬å ´", "å¤§å­¸", "å¤§åŸ”å¢Ÿ", "å¤ªå’Œ", "ç²‰å¶º", "ä¸Šæ°´", "ç¾…æ¹–", "è½é¦¬æ´²"],
            "å±¯é¦¬ç¶«": ["å±¯é–€", "å…†åº·", "å¤©æ°´åœ", "æœ—å±", "å…ƒæœ—", "éŒ¦ä¸Šè·¯", "èƒç£è¥¿", "ç¾å­š", "å—æ˜Œ", "æŸ¯å£«ç”¸", "å°–æ±", "ç´…ç£¡", "ä½•æ–‡ç”°", "åœŸç“œç£", "å®‹çš‡è‡º", "å•Ÿå¾·", "é‘½çŸ³å±±", "é¡¯å¾‘", "å¤§åœ", "è»Šå…¬å»Ÿ", "æ²™ç”°åœ", "ç¬¬ä¸€åŸ", "çŸ³é–€", "å¤§æ°´å‘", "æ†å®‰", "é¦¬éå±±", "çƒæºªæ²™"],
            "æ±æ¶Œç¶«": ["é¦™æ¸¯", "ä¹é¾", "å¥§é‹", "å—æ˜Œ", "è”æ™¯", "é’è¡£", "æ¬£æ¾³", "æ±æ¶Œ"]
        };

        let isInside = false;
        let currentTrip = {};
        let history = JSON.parse(localStorage.getItem('mtr_history')) || [];

        const statusDisplay = document.getElementById('status-display');
        const actionBtn = document.getElementById('action-btn');
        const currentTripInfo = document.getElementById('current-trip-info');
        const infoEntryStation = document.getElementById('info-entry-station');
        const infoEntryTime = document.getElementById('info-entry-time');
        const historyList = document.getElementById('history-list');
        const stationModal = document.getElementById('station-modal');
        const stationSelect = document.getElementById('station-select');
        const modalTitle = document.getElementById('modal-title');
        const locationMsg = document.getElementById('location-msg');
        const gpsStatus = document.getElementById('gps-status');

        window.onload = function() {
            initStationSelect();
            const savedTrip = localStorage.getItem('mtr_current_trip');
            if (savedTrip) {
                currentTrip = JSON.parse(savedTrip);
                isInside = true;
                updateUI(true);
            }
            renderHistory();
        };

        function initStationSelect() {
            stationSelect.innerHTML = '';
            for (const [line, stations] of Object.entries(mtrLines)) {
                const group = document.createElement('optgroup');
                group.label = line;
                stations.forEach(station => {
                    const option = document.createElement('option');
                    option.value = station;
                    option.textContent = station;
                    group.appendChild(option);
                });
                stationSelect.appendChild(group);
            }
        }

        function openStationModal() {
            modalTitle.textContent = isInside ? "è«‹é¸æ“‡å‡ºé–˜è»Šç«™" : "è«‹é¸æ“‡å…¥é–˜è»Šç«™";
            stationModal.classList.remove('hidden');
            detectLocation();
        }

        function closeModal() {
            stationModal.classList.add('hidden');
            locationMsg.innerHTML = '';
        }

        // --- GPS ---
        function detectLocation() {
            if (!navigator.geolocation) {
                locationMsg.innerHTML = '<span class="text-red-500">ç€è¦½å™¨ä¸æ”¯æŒå®šä½</span>';
                return;
            }
            locationMsg.innerHTML = '<div class="loader mr-2"></div><span class="text-blue-500">æ­£åœ¨æœå°‹æœ€è¿‘è»Šç«™...</span>';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const nearest = findNearestStation(userLat, userLng);
                    
                    if (nearest) {
                        stationSelect.value = nearest.name;
                        locationMsg.innerHTML = `<span class="text-green-600 font-bold"><i class="fas fa-map-marker-alt"></i> æœ€è¿‘: ${nearest.name} (${nearest.distance.toFixed(2)}km)</span>`;
                        gpsStatus.textContent = "GPS å·²å®šä½";
                        gpsStatus.classList.replace('bg-blue-800', 'bg-green-600');
                    } else {
                        locationMsg.innerHTML = '<span class="text-orange-500">æ‰¾ä¸åˆ°é™„è¿‘çš„è»Šç«™æ•¸æ“š</span>';
                    }
                },
                (error) => {
                    console.error(error);
                    locationMsg.innerHTML = '<span class="text-red-500">ç„¡æ³•ç²å–ä½ç½® (è«‹å…è¨±æ¬Šé™)</span>';
                    gpsStatus.textContent = "GPS å¤±æ•—";
                    gpsStatus.classList.replace('bg-blue-800', 'bg-red-600');
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        function findNearestStation(lat, lng) {
            let minDistance = Infinity;
            let nearestStation = null;
            for (const [name, coords] of Object.entries(stationCoords)) {
                const dist = getDistanceFromLatLonInKm(lat, lng, coords[0], coords[1]);
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestStation = name;
                }
            }
            if (minDistance > 50) return null;
            return { name: nearestStation, distance: minDistance };
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; 
            return d;
        }

        function deg2rad(deg) { return deg * (Math.PI/180) }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function confirmAction() {
            const selectedStation = stationSelect.value;
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-HK', { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString('zh-HK');

            if (!isInside) {
                currentTrip = {
                    date: dateString,
                    entryStation: selectedStation,
                    entryTime: timeString,
                    entryTimestamp: now.getTime()
                };
                localStorage.setItem('mtr_current_trip', JSON.stringify(currentTrip));
                isInside = true;
                updateUI(true);
            } else {
                const durationMs = now.getTime() - currentTrip.entryTimestamp;
                const durationMin = Math.floor(durationMs / 60000);

                const completeTrip = {
                    ...currentTrip,
                    exitStation: selectedStation,
                    exitTime: timeString,
                    duration: durationMin
                };

                history.unshift(completeTrip);
                localStorage.setItem('mtr_history', JSON.stringify(history));
                
                localStorage.removeItem('mtr_current_trip');
                currentTrip = {};
                isInside = false;
                updateUI(false);
                renderHistory();
            }
            closeModal();
        }

        function updateUI(inside) {
            if (inside) {
                actionBtn.classList.replace('bg-green-500', 'bg-orange-500');
                actionBtn.classList.replace('border-green-200', 'border-orange-200');
                actionBtn.innerHTML = `<div><i class="fas fa-sign-out-alt mb-2 text-3xl"></i></div><span>å‡ºé–˜</span>`;
                statusDisplay.innerHTML = `ç•¶å‰ç‹€æ…‹: <span class="text-orange-500 font-bold">å·²å…¥é–˜</span>`;
                infoEntryStation.textContent = currentTrip.entryStation;
                infoEntryTime.textContent = currentTrip.entryTime;
                currentTripInfo.classList.remove('hidden');
            } else {
                actionBtn.classList.replace('bg-orange-500', 'bg-green-500');
                actionBtn.classList.replace('border-orange-200', 'border-green-200');
                actionBtn.innerHTML = `<div><i class="fas fa-sign-in-alt mb-2 text-3xl"></i></div><span>å…¥é–˜</span>`;
                statusDisplay.innerHTML = `ç•¶å‰ç‹€æ…‹: <span class="text-gray-500">æœªå…¥é–˜</span>`;
                currentTripInfo.classList.add('hidden');
            }
        }

        function renderHistory() {
            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">æš«ç„¡ç´€éŒ„</p>';
                return;
            }
            historyList.innerHTML = history.map(trip => `
                <div class="bg-white p-3 rounded shadow-sm border-l-4 border-blue-500 flex justify-between items-center mr-1">
                    <div class="flex-1">
                        <div class="text-xs text-gray-400 mb-1">${trip.date}</div>
                        <div class="font-bold text-gray-800 text-lg">
                            ${trip.entryStation} <i class="fas fa-arrow-right text-xs text-gray-400 mx-1"></i> ${trip.exitStation}
                        </div>
                        <div class="text-sm text-gray-600">
                            ${trip.entryTime} - ${trip.exitTime}
                        </div>
                    </div>
                    <div class="text-right pl-2">
                        <div class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600 font-mono whitespace-nowrap">
                            ${trip.duration} åˆ†é˜
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿ")) {
                history = [];
                localStorage.removeItem('mtr_history');
                renderHistory();
            }
        }

        // --- CSV åŒ¯å‡ºåŠŸèƒ½ ---
        function downloadCSV() {
            if (history.length === 0) {
                alert("æš«æ™‚æ²’æœ‰æ­·å²ç´€éŒ„å¯ä»¥åŒ¯å‡ºï¼");
                return;
            }

            // 1. å®šç¾© CSV æ¨™é ­
            let csvContent = "\uFEFF"; // åŠ å…¥ BOM è®“ Excel è­˜åˆ¥ä¸­æ–‡
            csvContent += "æ—¥æœŸ,å…¥é–˜è»Šç«™,å…¥é–˜æ™‚é–“,å‡ºé–˜è»Šç«™,å‡ºé–˜æ™‚é–“,è€—æ™‚(åˆ†é˜)\n";

            // 2. å°‡æ­·å²ç´€éŒ„è½‰ç‚º CSV æ ¼å¼
            history.forEach(trip => {
                let row = [
                    trip.date,
                    trip.entryStation,
                    trip.entryTime,
                    trip.exitStation,
                    trip.exitTime,
                    trip.duration
                ].join(",");
                csvContent += row + "\n";
            });

            // 3. å»ºç«‹ä¸‹è¼‰é€£çµ
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            // 4. è¨­å®šæª”å (åŠ å…¥ç•¶å‰æ—¥æœŸ)
            const today = new Date().toISOString().slice(0, 10);
            link.setAttribute("href", url);
            link.setAttribute("download", `mtr_history_${today}.csv`);
            
            // 5. è§¸ç™¼ä¸‹è¼‰
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
